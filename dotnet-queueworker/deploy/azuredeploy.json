{
    "$schema": "https://schema.management.azure.com/schemas/2019-08-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "location": {
            "defaultValue": "northcentralusstage",
            "type": "String"
        },
        "environmentId": {
            "defaultValue": "",
            "type": "String"
        },
        "storageConnectionString": {
            "defaultValue": "",
            "type": "String"
        },
        "appInsightsConnectionString": {
            "defaultValue": "",
            "type": "String"
        }
    },
    "variables": {},
    "resources": [
        {
            "name": "queueworker",
            "type": "Microsoft.Web/containerApps",
            "apiVersion": "2021-03-01",
            "kind": "containerapp",
            "location": "[parameters('location')]",
            "properties": {
                "kubeEnvironmentId": "[parameters('environmentId')]",
                "configuration": {
                    "activeRevisionsMode": "single",
                    "secrets": [
                        {
                            "name": "queue-connection",
                            "value": "[parameters('storageConnectionString')]"
                        },
                        {
                            "name": "appinsights-connection",
                            "value": "[parameters('appInsightsConnectionString')]"
                        }
                    ]
                },
                "template": {
                    "containers": [
                        {
                            "image": "joergjo/dotnet-queueworker",
                            "name": "queueworker",
                            "env": [
                                {
                                    "name": "ApplicationInsights__ConnectionString",
                                    "secretref": "appinsights-connection"
                                },
                                {
                                    "name": "WorkerOptions__StorageConnectionString",
                                    "secretref": "queue-connection"
                                },
                                {
                                    "name": "WorkerOptions__QueueName",
                                    "value": "demoqueue"
                                },
                                {
                                    "name": "Logging__Console__DisableColors",
                                    "value": "true"
                                }
                            ]
                        }
                    ],
                    "scale": {
                        "minReplicas": 0,
                        "maxReplicas": 10,
                        "rules": [
                            {
                                "name": "myqueuerule",
                                "azureQueue": {
                                    "queueName": "demoqueue",
                                    "queueLength": 100,
                                    "auth": [
                                        {
                                            "secretRef": "queue-connection",
                                            "triggerParameter": "connection"
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    "dapr": {
                        "enabled": false
                    }
                }
            }
        }
    ]
}